<!DOCTYPE html>
<!-- saved from url=(0037)https://paco0x.org/how-to-fork-a-chi/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="On A Clear Disk You Can Seek Forever">
    <meta name="keywords" content="">
    <meta name="theme-color" content="">
    <link type="application/atom+xml" rel="alternate" href="http://paco0x.org/feed.xml" title="坚实的幻想">

    <title>How to fork a CHI gastoken? - Fantasy</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="https://paco0x.org/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://paco0x.org/how-to-fork-a-chi/">

    <!-- Bootstrap Core CSS -->
    <style class="anchorjs"></style><link rel="stylesheet" href="./How to fork a CHI gastoken_ - Fantasy_files/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./How to fork a CHI gastoken_ - Fantasy_files/paco-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="./How to fork a CHI gastoken_ - Fantasy_files/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="./How to fork a CHI gastoken_ - Fantasy_files/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script src="./How to fork a CHI gastoken_ - Fantasy_files/jquery.nav.js.下载"></script><script src="./How to fork a CHI gastoken_ - Fantasy_files/fastclick.min.js.下载"></script><script src="./How to fork a CHI gastoken_ - Fantasy_files/anchor.min.js.下载"></script><script type="text/x-mathjax-config;executed=true">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
    <script src="./How to fork a CHI gastoken_ - Fantasy_files/MathJax.js.下载" id=""></script>
<script src="./How to fork a CHI gastoken_ - Fantasy_files/embed.js.下载" data-timestamp="1690875791813"></script><style type="text/css">.MathJax_Hover_Frame {border-radius: .25em; -webkit-border-radius: .25em; -moz-border-radius: .25em; -khtml-border-radius: .25em; box-shadow: 0px 0px 15px #83A; -webkit-box-shadow: 0px 0px 15px #83A; -moz-box-shadow: 0px 0px 15px #83A; -khtml-box-shadow: 0px 0px 15px #83A; border: 1px solid #A6D ! important; display: inline-block; position: absolute}
.MathJax_Menu_Button .MathJax_Hover_Arrow {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 4px; -webkit-border-radius: 4px; -moz-border-radius: 4px; -khtml-border-radius: 4px; font-family: 'Courier New',Courier; font-size: 9px; color: #F0F0F0}
.MathJax_Menu_Button .MathJax_Hover_Arrow span {display: block; background-color: #AAA; border: 1px solid; border-radius: 3px; line-height: 0; padding: 4px}
.MathJax_Hover_Arrow:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_Hover_Arrow:hover span {background-color: #CCC!important}
</style><style type="text/css">#MathJax_About {position: fixed; left: 50%; width: auto; text-align: center; border: 3px outset; padding: 1em 2em; background-color: #DDDDDD; color: black; cursor: default; font-family: message-box; font-size: 120%; font-style: normal; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; border-radius: 15px; -webkit-border-radius: 15px; -moz-border-radius: 15px; -khtml-border-radius: 15px; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_About.MathJax_MousePost {outline: none}
.MathJax_Menu {position: absolute; background-color: white; color: black; width: auto; padding: 2px; border: 1px solid #CCCCCC; margin: 0; cursor: default; font: menu; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; z-index: 201; box-shadow: 0px 10px 20px #808080; -webkit-box-shadow: 0px 10px 20px #808080; -moz-box-shadow: 0px 10px 20px #808080; -khtml-box-shadow: 0px 10px 20px #808080; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
.MathJax_MenuItem {padding: 2px 2em; background: transparent}
.MathJax_MenuArrow {position: absolute; right: .5em; padding-top: .25em; color: #666666; font-size: .75em}
.MathJax_MenuActive .MathJax_MenuArrow {color: white}
.MathJax_MenuArrow.RTL {left: .5em; right: auto}
.MathJax_MenuCheck {position: absolute; left: .7em}
.MathJax_MenuCheck.RTL {right: .7em; left: auto}
.MathJax_MenuRadioCheck {position: absolute; left: 1em}
.MathJax_MenuRadioCheck.RTL {right: 1em; left: auto}
.MathJax_MenuLabel {padding: 2px 2em 4px 1.33em; font-style: italic}
.MathJax_MenuRule {border-top: 1px solid #CCCCCC; margin: 4px 1px 0px}
.MathJax_MenuDisabled {color: GrayText}
.MathJax_MenuActive {background-color: Highlight; color: HighlightText}
.MathJax_MenuDisabled:focus, .MathJax_MenuLabel:focus {background-color: #E8E8E8}
.MathJax_ContextMenu:focus {outline: none}
.MathJax_ContextMenu .MathJax_MenuItem:focus {outline: none}
#MathJax_AboutClose {top: .2em; right: .2em}
.MathJax_Menu .MathJax_MenuClose {top: -10px; left: -10px}
.MathJax_MenuClose {position: absolute; cursor: pointer; display: inline-block; border: 2px solid #AAA; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; font-family: 'Courier New',Courier; font-size: 24px; color: #F0F0F0}
.MathJax_MenuClose span {display: block; background-color: #AAA; border: 1.5px solid; border-radius: 18px; -webkit-border-radius: 18px; -moz-border-radius: 18px; -khtml-border-radius: 18px; line-height: 0; padding: 8px 0 6px}
.MathJax_MenuClose:hover {color: white!important; border: 2px solid #CCC!important}
.MathJax_MenuClose:hover span {background-color: #CCC!important}
.MathJax_MenuClose:hover:focus {outline: none}
</style><style type="text/css">.MathJax_Preview .MJXf-math {color: inherit!important}
</style><style type="text/css">.MJX_Assistive_MathML {position: absolute!important; top: 0; left: 0; clip: rect(1px, 1px, 1px, 1px); padding: 1px 0 0 0!important; border: 0!important; height: 1px!important; width: 1px!important; overflow: hidden!important; display: block!important; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none}
.MJX_Assistive_MathML.MJX_Assistive_MathML_Block {width: 100%!important}
</style><style type="text/css">#MathJax_Zoom {position: absolute; background-color: #F0F0F0; overflow: auto; display: block; z-index: 301; padding: .5em; border: 1px solid black; margin: 0; font-weight: normal; font-style: normal; text-align: left; text-indent: 0; text-transform: none; line-height: normal; letter-spacing: normal; word-spacing: normal; word-wrap: normal; white-space: nowrap; float: none; -webkit-box-sizing: content-box; -moz-box-sizing: content-box; box-sizing: content-box; box-shadow: 5px 5px 15px #AAAAAA; -webkit-box-shadow: 5px 5px 15px #AAAAAA; -moz-box-shadow: 5px 5px 15px #AAAAAA; -khtml-box-shadow: 5px 5px 15px #AAAAAA; filter: progid:DXImageTransform.Microsoft.dropshadow(OffX=2, OffY=2, Color='gray', Positive='true')}
#MathJax_ZoomOverlay {position: absolute; left: 0; top: 0; z-index: 300; display: inline-block; width: 100%; height: 100%; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
#MathJax_ZoomFrame {position: relative; display: inline-block; height: 0; width: 0}
#MathJax_ZoomEventTrap {position: absolute; left: 0; top: 0; z-index: 302; display: inline-block; border: 0; padding: 0; margin: 0; background-color: white; opacity: 0; filter: alpha(opacity=0)}
</style><style type="text/css">.MathJax_Preview {color: #888}
#MathJax_Message {position: fixed; left: 1em; bottom: 1.5em; background-color: #E6E6E6; border: 1px solid #959595; margin: 0px; padding: 2px 8px; z-index: 102; color: black; font-size: 80%; width: auto; white-space: nowrap}
#MathJax_MSIE_Frame {position: absolute; top: 0; left: 0; width: 0px; z-index: 101; border: 0px; margin: 0px; padding: 0px}
.MathJax_Error {color: #CC0000; font-style: italic}
</style><style type="text/css">.MJXp-script {font-size: .8em}
.MJXp-right {-webkit-transform-origin: right; -moz-transform-origin: right; -ms-transform-origin: right; -o-transform-origin: right; transform-origin: right}
.MJXp-bold {font-weight: bold}
.MJXp-italic {font-style: italic}
.MJXp-scr {font-family: MathJax_Script,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-frak {font-family: MathJax_Fraktur,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-sf {font-family: MathJax_SansSerif,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-cal {font-family: MathJax_Caligraphic,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-mono {font-family: MathJax_Typewriter,'Times New Roman',Times,STIXGeneral,serif}
.MJXp-largeop {font-size: 150%}
.MJXp-largeop.MJXp-int {vertical-align: -.2em}
.MJXp-math {display: inline-block; line-height: 1.2; text-indent: 0; font-family: 'Times New Roman',Times,STIXGeneral,serif; white-space: nowrap; border-collapse: collapse}
.MJXp-display {display: block; text-align: center; margin: 1em 0}
.MJXp-math span {display: inline-block}
.MJXp-box {display: block!important; text-align: center}
.MJXp-box:after {content: " "}
.MJXp-rule {display: block!important; margin-top: .1em}
.MJXp-char {display: block!important}
.MJXp-mo {margin: 0 .15em}
.MJXp-mfrac {margin: 0 .125em; vertical-align: .25em}
.MJXp-denom {display: inline-table!important; width: 100%}
.MJXp-denom > * {display: table-row!important}
.MJXp-surd {vertical-align: top}
.MJXp-surd > * {display: block!important}
.MJXp-script-box > *  {display: table!important; height: 50%}
.MJXp-script-box > * > * {display: table-cell!important; vertical-align: top}
.MJXp-script-box > *:last-child > * {vertical-align: bottom}
.MJXp-script-box > * > * > * {display: block!important}
.MJXp-mphantom {visibility: hidden}
.MJXp-munderover {display: inline-table!important}
.MJXp-over {display: inline-block!important; text-align: center}
.MJXp-over > * {display: block!important}
.MJXp-munderover > * {display: table-row!important}
.MJXp-mtable {vertical-align: .25em; margin: 0 .125em}
.MJXp-mtable > * {display: inline-table!important; vertical-align: middle}
.MJXp-mtr {display: table-row!important}
.MJXp-mtd {display: table-cell!important; text-align: center; padding: .5em 0 0 .5em}
.MJXp-mtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-mlabeledtr {display: table-row!important}
.MJXp-mlabeledtr > .MJXp-mtd:first-child {padding-left: 0}
.MJXp-mlabeledtr:first-child > .MJXp-mtd {padding-top: 0}
.MJXp-merror {background-color: #FFFF88; color: #CC0000; border: 1px solid #CC0000; padding: 1px 3px; font-style: normal; font-size: 90%}
.MJXp-scale0 {-webkit-transform: scaleX(.0); -moz-transform: scaleX(.0); -ms-transform: scaleX(.0); -o-transform: scaleX(.0); transform: scaleX(.0)}
.MJXp-scale1 {-webkit-transform: scaleX(.1); -moz-transform: scaleX(.1); -ms-transform: scaleX(.1); -o-transform: scaleX(.1); transform: scaleX(.1)}
.MJXp-scale2 {-webkit-transform: scaleX(.2); -moz-transform: scaleX(.2); -ms-transform: scaleX(.2); -o-transform: scaleX(.2); transform: scaleX(.2)}
.MJXp-scale3 {-webkit-transform: scaleX(.3); -moz-transform: scaleX(.3); -ms-transform: scaleX(.3); -o-transform: scaleX(.3); transform: scaleX(.3)}
.MJXp-scale4 {-webkit-transform: scaleX(.4); -moz-transform: scaleX(.4); -ms-transform: scaleX(.4); -o-transform: scaleX(.4); transform: scaleX(.4)}
.MJXp-scale5 {-webkit-transform: scaleX(.5); -moz-transform: scaleX(.5); -ms-transform: scaleX(.5); -o-transform: scaleX(.5); transform: scaleX(.5)}
.MJXp-scale6 {-webkit-transform: scaleX(.6); -moz-transform: scaleX(.6); -ms-transform: scaleX(.6); -o-transform: scaleX(.6); transform: scaleX(.6)}
.MJXp-scale7 {-webkit-transform: scaleX(.7); -moz-transform: scaleX(.7); -ms-transform: scaleX(.7); -o-transform: scaleX(.7); transform: scaleX(.7)}
.MJXp-scale8 {-webkit-transform: scaleX(.8); -moz-transform: scaleX(.8); -ms-transform: scaleX(.8); -o-transform: scaleX(.8); transform: scaleX(.8)}
.MJXp-scale9 {-webkit-transform: scaleX(.9); -moz-transform: scaleX(.9); -ms-transform: scaleX(.9); -o-transform: scaleX(.9); transform: scaleX(.9)}
.MathJax_PHTML .noError {vertical-align: ; font-size: 90%; text-align: left; color: black; padding: 1px 3px; border: 1px solid}
</style><script src="./How to fork a CHI gastoken_ - Fantasy_files/alfie_v4.63f1ab6d6b9d5807dc0c94ef3fe0b851.js.下载" async="" charset="UTF-8"></script></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart=""><div id="MathJax_Message" style="display: none;"></div>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top is-fixed">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://paco0x.org/">坚实的幻想</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar" class=" ">
            <div class="navbar-collapse" style="height: 0px;">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="https://paco0x.org/">Home</a>
                    </li>
                    
                    <li>
                        <a href="https://paco0x.org/about/">About</a>
                    </li>
                    
                    <li>
                        <a href="https://paco0x.org/archives/">Archives</a>
                    </li>
                    
                    <li>
                        <a href="https://paco0x.org/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.jpg" width="0" height="0"> -->
<!-- <img src="/img/in-post/how-to-fork-a-chi/chi.png" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)), url('/img/in-post/how-to-fork-a-chi/chi.png');
        background-attachment: fixed;
    }

    
</style>
<header class="intro-header">
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="https://paco0x.org/tags/#Solidity" title="Solidity">Solidity</a>
                        
                        <a class="tag" href="https://paco0x.org/tags/#Ethereum" title="Ethereum">Ethereum</a>
                        
                        <a class="tag" href="https://paco0x.org/tags/#EVM" title="EVM">EVM</a>
                        
                    </div>
                    <h1 id="how-to-fork-a-chi-gastoken">How to fork a CHI gastoken?</h1>
                    
                    
                    <h2 class="subheading" id="-1"></h2>
                    
                    <span class="meta">Posted on July 12, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<p>Fork CHI gastoken 的想法来自于和一位网友的对话。这位网友打算 fork 一个自己的 CHI gastoken，并优化其中的某些步骤，来让自己的合约的 gas 开销更加低一些。但是他在 fork CHI 代码部署之后，却发现无法成功执行 <code class="language-plaintext highlighter-rouge">CHI.free()</code> 操作。正好我在之前学习 gastoken 原理的时候看过 CHI 的具体实现，就尝试帮他解决了这个问题。</p>

<p>我觉得这个任务还是蛮具有挑战性的（其实可以作为一个面试/笔试实操题目？），需要对 EVM 指令，内存布局，合约地址，call 调用等细节都有一定的了解，因此在这里记录下整个过程。</p>

<h1 id="what-is-gastoken">What is gastoken<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#what-is-gastoken" aria-label="Anchor link for: what is gastoken" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h1>

<p>以太坊上所有的智能合约，都是编译成 EVM 指令来运行的，在运行的过程中，根据指令的开销不同，会向用户收取不同数量的 gas，调用合约所运行的指令需要花费的 gas 总和就是交易所需要的 gas 总和。gastoken 就是一种可以用来降低交易 gas 开销的特殊 token，它利用了以太坊在早期设计的一个 gas 折扣规则来实现降低 gas 开销。</p>

<p>我们知道合约中的数据，都是永久保存在链上的，随着区块链运行的时间越久，链上所保存的数据也就越多，但是这些数据很多可能都是无效的数据。在以太坊设计时，为了鼓励开发者将没用的数据和合约清理掉，如果在交易中对合约进行销毁（<code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code>）或者将合约存储 slots 中的数据清空（<code class="language-plaintext highlighter-rouge">SSTORE[x] = 0</code>），都可以获得 gas 折扣，即在原先要消耗的 gas 基础上打一个折扣，这样交易的 gas 开销就变小了。（具体的 gas refund 实现可以参考：<a href="https://github.com/ethereum/go-ethereum/blob/94451c2788295901c302c9bf5fa2f7b021c924e2/core/vm/gas_table.go#L420-L441">core/vm/gas_table.go</a>）</p>

<p>于是就有开发者利用这个规则，开发出了各种 gastoken. 他们的原理大同小异，都是允许用户在 gas price 比较低的时候 <code class="language-plaintext highlighter-rouge">mint</code> gastoken，然后在 gas price 较高时将 gastoken <code class="language-plaintext highlighter-rouge">burn</code> 掉，这样就可以在高 gas price 时节省 gas 开销。</p>

<p>那么 gastoken 的 <code class="language-plaintext highlighter-rouge">mint</code> 和 <code class="language-plaintext highlighter-rouge">burn</code> 背后又会执行什么操作呢？对于 <code class="language-plaintext highlighter-rouge">mint</code> 操作，一般来说，合约会创建一些新的合约，或者向 slots 中写入一些无效的数据。反之，在 <code class="language-plaintext highlighter-rouge">burn</code> 操作时，又会将之前创建的合约销毁掉，或者将存储空间中的数据清零。</p>

<p>gastoken 实际上是滥用了以太坊的 refund 机制，因此以太坊在未来也将消弱这个 refund，使其不再能够被用于 gas token。具体可以参考：<a href="https://eips.ethereum.org/EIPS/eip-3529">EIP-3529: Reduction in refunds</a>，此 EIP 将在以太坊<a href="https://blog.ethereum.org/2021/07/15/london-mainnet-announcement/">伦敦分叉</a>后实行。</p>

<h1 id="why-use-gastoken">Why use gastoken<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#why-use-gastoken" aria-label="Anchor link for: why use gastoken" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h1>

<p>gas token 一般在以下场景使用：</p>

<ol>
  <li>使用 high gas price 来抢先打包交易。这种场景使用 gas token 可以减少总体的 gas 消耗，矿工一般不会实际模拟这些交易，而是直接按 gas price 来打包</li>
  <li>使用 flashbots 时，降低 gas 的占用。这种场景使用 gas token 可以让那个自己的交易 gas 消耗更少，虽然 miner bribe 不会变少，但是会给矿工打包区块节省 gas（区块的 gas 是有上限的），因此能增加 bundle 的竞争力</li>
  <li>在 gas 很高的时候，用 gas token 降低开销。这种场景需要调用的合约支持使用 gas token</li>
  <li>因为 gastoken 是有价值的（可以交易），矿工在需要出空块的时候（为了快速打包区块他们有时候会出空块），可以选择全部 mint gastoken，参考<a href="https://compassmining.io/education/empty-blocks-gas-chi-tokens-ether-pools-mining/">这篇文章</a></li>
</ol>

<h1 id="chi-gastoken">CHI gastoken<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#chi-gastoken" aria-label="Anchor link for: chi gastoken" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h1>

<p>CHI gastoken 是 gastoken 的一种，由 1inch 开发，它比其他的一些 gastoken 会更加高效精简一些，具体介绍可以参考 <a href="https://blog.1inch.io/everything-you-wanted-to-know-about-chi-gastoken-a1ba0ea55bf3">Everything you wanted to know about Chi Gastoken</a>.</p>

<p>CHI 的工作原理也是允许用户 <code class="language-plaintext highlighter-rouge">mint</code> 和 <code class="language-plaintext highlighter-rouge">free</code> CHI token. 在 <code class="language-plaintext highlighter-rouge">mint</code> 时会根据指定的数量创建一系列的子合约，在 <code class="language-plaintext highlighter-rouge">free</code> 时会将之前创建的子合约销毁掉。下面我们参考它的源代码来讲解一下它的工作流程，这里我们参考 etherscan 上开源的代码：<a href="https://etherscan.io/address/0x0000000000004946c0e9F43F4Dee607b0eF1fA1c#contracts">https://etherscan.io/address/0x0000000000004946c0e9F43F4Dee607b0eF1fA1c#contracts</a>，这份代码和其 <a href="https://github.com/1inch/chi/blob/master/contracts/ChiToken.sol">GitHub</a> 上的最新代码会略有不同（GitHub 上的代码使用了更多的 inline assembly）。</p>

<h2 id="mint-gastoken">mint gastoken<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#mint-gastoken" aria-label="Anchor link for: mint gastoken" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h2>

<p>使用合约的 <code class="language-plaintext highlighter-rouge">mint(uint256 value)</code> 可以用来 <code class="language-plaintext highlighter-rouge">mint</code> CHI token.</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">mint</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">value</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">totalMinted</span><span class="p">;</span>
    <span class="k">assembly</span> <span class="p">{</span>
        <span class="n">mstore</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x746d4946c0e9F43F4Dee607b0eF1fA1c3318585733ff6000526015600bf30000</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">{</span><span class="kr">let</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">div</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mi">32</span><span class="p">)}</span> <span class="n">i</span> <span class="p">{</span><span class="n">i</span> <span class="o">:=</span> <span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span> <span class="p">{</span>
            <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
            <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span> <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="c1">// ...省略类似代码
</span>            <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">30</span><span class="p">)))</span> <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">31</span><span class="p">)))</span>
            <span class="n">offset</span> <span class="o">:=</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">{</span><span class="kr">let</span> <span class="n">i</span> <span class="o">:=</span> <span class="n">and</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">)}</span> <span class="n">i</span> <span class="p">{</span><span class="n">i</span> <span class="o">:=</span> <span class="n">sub</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span> <span class="p">{</span>
            <span class="n">pop</span><span class="p">(</span><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">offset</span><span class="p">))</span>
            <span class="n">offset</span> <span class="o">:=</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">_mint</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">totalMinted</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">mint(uint256 value)</code> 的接收参数表示需要 mint 的 gastoken 数量。在函数中会使用循环，调用 <code class="language-plaintext highlighter-rouge">create2</code> 创建子合约。这里使用了 <code class="language-plaintext highlighter-rouge">create2</code> 指令来创建子合约，这样做的目的是，后续可以通过计算，来计算出子合约的地址。关于 <code class="language-plaintext highlighter-rouge">create2</code> 指令，可以参考 <a href="https://eips.ethereum.org/EIPS/eip-1014">EIP-1014</a>。在 Yul 中，<code class="language-plaintext highlighter-rouge">create2</code> 函数接收的 4 个参数的意义分别表示：</p>

<ol>
  <li>创建合约调用时传入的 value（wei）</li>
  <li>内存中 <code class="language-plaintext highlighter-rouge">initcode</code> 的起始地址</li>
  <li>内存中 <code class="language-plaintext highlighter-rouge">initcode</code> 的结束地址</li>
  <li>salt</li>
</ol>

<p>这里会使用 <code class="language-plaintext highlighter-rouge">offset+i</code> 的方式构造不同的 salt 来创建合约，以保证每一个合约的地址都是唯一的。并且能够方便的用这个 salt 反向计算出创建出的合约地址。通过 <code class="language-plaintext highlighter-rouge">CREATE2</code> 这种方式创建子合约，CHI 合约就不用存储创建过的每一个合约地址了，这样做极大的节省了需要存储的空间。</p>

<p>那么创建的 <code class="language-plaintext highlighter-rouge">initcode</code> 又是什么呢？其实就包含在这一段代码中：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mstore</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x746d4946c0e9F43F4Dee607b0eF1fA1c3318585733ff6000526015600bf30000</span><span class="p">)</span>
</code></pre></div></div>

<p>这里将一个 32byte 的字节载入到了内存中的 0 地址上。这一段 32byte 的字节就是编译好之后的 <code class="language-plaintext highlighter-rouge">initcode</code>，实际上它之后 30byte，最后的 <code class="language-plaintext highlighter-rouge">0000</code> 仅为了填充所使用。那么内存中 0 ～ 30 byte 的内容就是我们创建合约的 <code class="language-plaintext highlighter-rouge">initcode</code> 了。在创建合约时，会在新合约的地址空间上直接运行 <code class="language-plaintext highlighter-rouge">initcode</code>，<code class="language-plaintext highlighter-rouge">initcode</code> 通常会返回一串字节流，这串字节流就是这个地址上合约的 <code class="language-plaintext highlighter-rouge">bytecode</code>，它会被永久保存在链上，后续所有对新合约的调用都会运行这段 <code class="language-plaintext highlighter-rouge">bytecode</code>.</p>

<p>简单来说：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">initcode</code>，有时也被称作 <code class="language-plaintext highlighter-rouge">runtime code</code>，就是创建新合约时运行的代码，它只会运行一次，在 solidity 中通常被用来运行 <code class="language-plaintext highlighter-rouge">constructor</code> 函数的代码</li>
  <li><code class="language-plaintext highlighter-rouge">bytecode</code> 是调用已创建合约时运行的代码，它会永久保存在链上（除非调用 <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code> 销毁合约）</li>
</ul>

<h3 id="initcode"><code class="language-plaintext highlighter-rouge">initcode</code><a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#initcode" aria-label="Anchor link for: initcode" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p>那么这段 <code class="language-plaintext highlighter-rouge">initcode</code> 又做了什么呢？我们将它解码成 evm 指令来看一下（这里用的 <a href="https://ethervm.io/decompile">Online Solidity Decompiler</a> 这个工具）：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0000</span>    <span class="mi">74</span>  <span class="n">PUSH21</span> <span class="mh">0x6d4946c0e9f43f4dee607b0ef1fa1c3318585733ff</span>
<span class="mi">0016</span>    <span class="mi">60</span>  <span class="n">PUSH1</span> <span class="mh">0x00</span>
<span class="mi">0018</span>    <span class="mi">52</span>  <span class="n">MSTORE</span>
<span class="mi">0019</span>    <span class="mi">60</span>  <span class="n">PUSH1</span> <span class="mh">0x15</span>
<span class="mi">001</span><span class="n">B</span>    <span class="mi">60</span>  <span class="n">PUSH1</span> <span class="mh">0x0b</span>
<span class="mi">001</span><span class="n">D</span>    <span class="n">F3</span>  <span class="o">*</span><span class="n">RETURN</span>
</code></pre></div></div>

<p>这里第一列表示指令的偏移量，第二列表示指令的 opcode 码，最后表示指令的内容。这一段 <code class="language-plaintext highlighter-rouge">initcode</code> 其实只做了一件事，就是把 <code class="language-plaintext highlighter-rouge">6d4946c0e9f43f4dee607b0ef1fa1c3318585733ff</code> 这段字节加载到内存中，然后调用 <code class="language-plaintext highlighter-rouge">RETURN</code> 将这段字节返回。这段字节码就会作为新创建合约的 <code class="language-plaintext highlighter-rouge">bytecode</code> 被保存在链上了。</p>

<p>我们可以详细分析运行过程中 EVM 堆栈的情况：</p>

<p>首先，执行 <code class="language-plaintext highlighter-rouge">PUSH21</code> 和 <code class="language-plaintext highlighter-rouge">PUSH1</code>，此时栈空间内容为：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">STACK</span><span class="p">]</span>
<span class="mi">0</span><span class="o">:</span> <span class="mh">0x0000000000000000000000000000000000000000000000000000000000000000</span>
<span class="mi">1</span><span class="o">:</span> <span class="mh">0x00000000000000000000006d4946c0e9f43f4dee607b0ef1fa1c3318585733ff</span>
</code></pre></div></div>

<p>然后执行 <code class="language-plaintext highlighter-rouge">MSTORE</code>，它会将栈 1 中的字节流存储到栈 0 中指定的内存地址中，执行完成后栈空间就被清空了，而内存空间为：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">MEMORY</span><span class="p">]</span>
<span class="mh">0x0</span><span class="o">:</span> <span class="mh">0x00000000000000000000006d4946c0e9f43f4dee607b0ef1fa1c3318585733ff</span>
</code></pre></div></div>

<p>最后我们要将内存中内存地址 <code class="language-plaintext highlighter-rouge">[11, 32)</code> 的代码返回，从内存地址 11 开始，是因为需要跳过首部 11 个 byte 的 <code class="language-plaintext highlighter-rouge">0</code>. 因此最后几行指令可以翻译成 Yul 代码 <code class="language-plaintext highlighter-rouge">return(11, 21)</code>，即将内存中 <code class="language-plaintext highlighter-rouge">[11, 32)</code> 中的值返回，这里返回的就是创建合约的 <code class="language-plaintext highlighter-rouge">bytecode</code> ，也就是 <code class="language-plaintext highlighter-rouge">mint</code> 操作创建的新合约的 <code class="language-plaintext highlighter-rouge">bytecode</code>。之后这段 <code class="language-plaintext highlighter-rouge">initcode</code> 运行结束，它所返回的 <code class="language-plaintext highlighter-rouge">bytecode</code> 被存储到合约地址中。</p>

<h3 id="bytecode"><code class="language-plaintext highlighter-rouge">bytecode</code><a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#bytecode" aria-label="Anchor link for: bytecode" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p>那么这段 <code class="language-plaintext highlighter-rouge">bytecode</code> 又包含了什么指令呢？我们继续解码这段 <code class="language-plaintext highlighter-rouge">bytecode</code>（仍然使用 <a href="https://ethervm.io/decompile">Online Solidity Decompiler</a>）：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0000</span>    <span class="mi">6</span><span class="n">D</span>  <span class="n">PUSH14</span> <span class="mh">0x4946c0e9f43f4dee607b0ef1fa1c</span>
<span class="mi">000</span><span class="n">F</span>    <span class="mi">33</span>  <span class="n">CALLER</span>
<span class="mi">0010</span>    <span class="mi">18</span>  <span class="n">XOR</span>
<span class="mi">0011</span>    <span class="mi">58</span>  <span class="n">PC</span>
<span class="mi">0012</span>    <span class="mi">57</span>  <span class="o">*</span><span class="n">JUMPI</span>
<span class="mi">0013</span>    <span class="mi">33</span>  <span class="n">CALLER</span>
<span class="mi">0014</span>    <span class="n">FF</span>  <span class="o">*</span><span class="n">SELFDESTRUCT</span>
</code></pre></div></div>

<p>这段 <code class="language-plaintext highlighter-rouge">bytecode</code> 要做的事情其实很简单：</p>

<ol>
  <li>使用 <code class="language-plaintext highlighter-rouge">XOR</code> 将 caller 地址与 <code class="language-plaintext highlighter-rouge">0x000000000000004946c0e9f43f4dee607b0ef1fa1c</code> 进行比较</li>
  <li>将 Program Counter 记录到栈上</li>
  <li>如果 <code class="language-plaintext highlighter-rouge">XOR</code> 结果不为 0，那么会使用 <code class="language-plaintext highlighter-rouge">JUMPI</code> 进行跳转，但是因为没有合法的 <code class="language-plaintext highlighter-rouge">JUMPDEST</code>，这个指令会直接 <code class="language-plaintext highlighter-rouge">revert</code>，并且消耗光所有的剩余 gas</li>
  <li>如果<code class="language-plaintext highlighter-rouge">XOR</code> 结果为 0，那么代码回不进行跳回，而会继续执行到 <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code> 指令，合约将被销毁</li>
</ol>

<p>因为这是一段手工编写的 opcode，它并没有 solidity 编译后的 opcodes 那么复杂，这样也节省了很多的运行开销。</p>

<p>这里的 <code class="language-plaintext highlighter-rouge">0x000000000000004946c0e9f43f4dee607b0ef1fa1c</code> 就是 <a href="https://etherscan.io/address/0x0000000000004946c0e9F43F4Dee607b0eF1fA1c#contracts">CHI Gastoken</a> 的地址。因此在写 CHI 代码时需要先计算出将要部署的合约的地址，然后将其填充到这段 <code class="language-plaintext highlighter-rouge">bytecode</code> 中。这里 1inch 计算出了一个以 <code class="language-plaintext highlighter-rouge">0x000000000000...</code> 起始的地址，这样可以让 <code class="language-plaintext highlighter-rouge">bytecode</code> 更加的精简，可以说是将优化进行到了极致。</p>

<p>在创建完成子合约之后，会通过 <code class="language-plaintext highlighter-rouge">_mint(msg.sender, value)</code> 给用户 <code class="language-plaintext highlighter-rouge">mint</code> token，作为销毁时的使用凭证。</p>

<h2 id="burn-gastoken">burn gastoken<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#burn-gastoken" aria-label="Anchor link for: burn gastoken" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h2>

<p>在使用 gas token 时，CHI 提供了多个不同的 <code class="language-plaintext highlighter-rouge">burn</code> 方式，这里我们看最简单的一种：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">computeAddress2</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">salt</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bytes32</span> <span class="n">_data</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span>
        <span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="kt">bytes1</span><span class="p">(</span><span class="mh">0xff</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">salt</span><span class="p">,</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mh">0x3c1644c68e5d6cb380c36d1bf847fdbc0c7ac28030025a2fc5e63cce23c16348</span><span class="p">))</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="n">_data</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">_destroyChildren</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">value</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">_totalBurned</span> <span class="o">=</span> <span class="n">totalBurned</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">computeAddress2</span><span class="p">(</span><span class="n">_totalBurned</span> <span class="o">+</span> <span class="n">i</span><span class="p">).</span><span class="nb">call</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">totalBurned</span> <span class="o">=</span> <span class="n">_totalBurned</span> <span class="o">+</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">free</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>  <span class="p">{</span>
    <span class="n">_burn</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">_destroyChildren</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>调用 <code class="language-plaintext highlighter-rouge">free(uint256 value)</code> 就可以进行 gas token 的销毁。</p>

<p>函数内会首先调用 <code class="language-plaintext highlighter-rouge">_burn(msg.sender, value)</code> 将用户的 ERC20 token 销毁，然后调用 <code class="language-plaintext highlighter-rouge">_destroyChildren()</code> 来销毁子合约。销毁子合约时，先用 <code class="language-plaintext highlighter-rouge">computeAddress2</code> 计算出子合约的地址，在计算时，我们需要使用 <code class="language-plaintext highlighter-rouge">salt</code> 以及 <code class="language-plaintext highlighter-rouge">initcode</code> hash，这里的 <code class="language-plaintext highlighter-rouge">0x3c1644c68e5d6cb380c36d1bf847fdbc0c7ac28030025a2fc5e63cce23c16348</code> 就是 <code class="language-plaintext highlighter-rouge">initcode</code> hash，即：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">keccak256</span><span class="p">(</span><span class="dl">'</span><span class="s1">0x746d4946c0e9F43F4Dee607b0eF1fA1c3318585733ff6000526015600bf3</span><span class="dl">'</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">0x3c1644c68e5d6cb380c36d1bf847fdbc0c7ac28030025a2fc5e63cce23c16348</span><span class="dl">'</span>
</code></pre></div></div>

<p>计算出子合约的地址后，会直接进行 <code class="language-plaintext highlighter-rouge">.call("")</code> 调用来销毁它：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">computeAddress2</span><span class="p">(</span><span class="n">_totalBurned</span> <span class="o">+</span> <span class="n">i</span><span class="p">).</span><span class="nb">call</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
</code></pre></div></div>

<p>这里 <code class="language-plaintext highlighter-rouge">call</code> 调用会执行子合约中的代码，即在<a href="https://paco0x.org/how-to-fork-a-chi/#bytecode">bytecode</a>中讲解的代码，首先会对调用者进行检查，然后销毁合约。因为子合约中对调用者进行了检查，因此其他人即使知道你在 mint CHI gastoken 时创建的子合约地址，他们无法销毁你创建的子合约。因为子合约只可以被来源是 CHI 合约的地址所销毁。</p>

<h1 id="how-to-fork-a-chi">How to fork a CHI?<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#how-to-fork-a-chi" aria-label="Anchor link for: how to fork a chi" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h1>

<p>了解了 CHI 的工作原理之后，我们知道如果直接 fork CHI 的代码部署，会有一个问题是，CHI 中部署子合约所使用的 <code class="language-plaintext highlighter-rouge">bytecode</code> 硬编码了一个 <code class="language-plaintext highlighter-rouge">0x000000000000004946c0e9f43f4dee607b0ef1fa1c</code> 的地址，用来进行 <code class="language-plaintext highlighter-rouge">Caller</code> 地址检查，如果我们直接 fork CHI 的代码，这个硬编码地址将和 fork 后部署的合约地址不匹配，导致无法正确销毁 <code class="language-plaintext highlighter-rouge">mint</code> 时创建的子合约。</p>

<p>这里我首先使用测试网原封不动的 fork CHI 合约后部署，进行测试，在调用 <code class="language-plaintext highlighter-rouge">free()</code> burn 掉 CHI token 时，会产生以下错误：</p>

<p><img src="./How to fork a CHI gastoken_ - Fantasy_files/burn-error.png" alt="burn-error"></p>

<p>错误提示是 <code class="language-plaintext highlighter-rouge">Bad jump destination</code>，即之前在 <a href="https://paco0x.org/how-to-fork-a-chi/#bytecode">bytecode</a> 中所讲的，<code class="language-plaintext highlighter-rouge">CALLER</code> 地址将与 <code class="language-plaintext highlighter-rouge">0x000000000000004946c0e9f43f4dee607b0ef1fa1c</code> 这个硬编码地址进行 <code class="language-plaintext highlighter-rouge">XOR</code> 比较，因为我 fork 后部署的 CHI 合约地址并不是这个地址，会导致比较的结果不为 0，然后会执行 <code class="language-plaintext highlighter-rouge">JUMPI</code>，进行了一个无效的跳转。EVM 在执行指令时，如果发生这种错误会将链上状态 revert 并直接消耗完所有剩余 gas（具体实现参考：<a href="https://github.com/ethereum/go-ethereum/blob/94451c2788295901c302c9bf5fa2f7b021c924e2/core/vm/evm.go#L263-L274">core/vm/evm.go</a>）。</p>

<h2 id="tackle-the-bytecode">Tackle the bytecode<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#tackle-the-bytecode" aria-label="Anchor link for: tackle the bytecode" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h2>

<p>为了我们 fork 的 CHI 合约能正常工作，我们需要将合约中硬编码的 bytecode 改写，将其中应硬编码的地址 <code class="language-plaintext highlighter-rouge">4946c0e9f43f4dee607b0ef1fa1c</code>（省略前面的 <code class="language-plaintext highlighter-rouge">0</code>）改成我们 fork 合约的地址。</p>

<p>这里 CHI 的合约地址因为是一个特殊地址（以 0 开头），在 <code class="language-plaintext highlighter-rouge">initcode</code> 中进行 PUSH 操作时可以省去前面的 <code class="language-plaintext highlighter-rouge">0</code>，因此它能够缩短 <code class="language-plaintext highlighter-rouge">initcode</code> 和 <code class="language-plaintext highlighter-rouge">bytecode</code> 的大小，并且节省 <code class="language-plaintext highlighter-rouge">PUSH</code> 操作的 gas 开销。这也是为什么很多 hacker 喜欢以 <code class="language-plaintext highlighter-rouge">0</code> 开头的账号，部署以 <code class="language-plaintext highlighter-rouge">0</code> 开头的合约的原因。</p>

<p>这里我为了方便，就不去暴力找寻能够产生以 <code class="language-plaintext highlighter-rouge">0</code> 开头合约地址的账号了。那么第一个任务就是预计算 fork 合约地址。</p>

<h3 id="compute-the-contract-address-in-advance">Compute the contract address in advance<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#compute-the-contract-address-in-advance" aria-label="Anchor link for: compute the contract address in advance" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p>以太坊中合约一共有两种创建方式，第一种是使用 <code class="language-plaintext highlighter-rouge">CREATE</code> 指令，第二种是使用 <code class="language-plaintext highlighter-rouge">CREATE2</code> 指令。第二种方式在之前已经讲过，它只能在合约中使用。我们正常部署一个合约都是使用的第一种创建方式，这种方式创建的合约地址计算方式为：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">"</span><span class="s2">0x</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">rlp</span><span class="p">.</span><span class="nx">encode</span><span class="p">([</span><span class="nx">SENDER</span><span class="p">,</span> <span class="nx">NONCE</span><span class="p">])).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">26</span><span class="p">);</span>
</code></pre></div></div>

<p>即将 <code class="language-plaintext highlighter-rouge">sender</code> 地址和 <code class="language-plaintext highlighter-rouge">nonce</code> 使用 rlp 编码后进行 <code class="language-plaintext highlighter-rouge">keccak256</code> 计算，并取计算结果末尾的 20 个字节作为合约地址。那么我们在部署合约之前，将部署账号的地址和 next nonce 作为参数，就可以计算出即将部署的合约地址了。</p>

<p>这里我使用 <a href="http://remix.ethereum.org/">remix</a> 来进行部署测试，我的部署账号地址为：<code class="language-plaintext highlighter-rouge">0x5B38Da6a701c568545dCfcB03FcB875f56beddC4</code>，因为之前没有执行过交易，因此下一次交易的 nonce 为 0，那么可以计算出即将部署的合约地址：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="dl">'</span><span class="s1">0x</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">rlp</span><span class="p">.</span><span class="nx">encode</span><span class="p">([</span><span class="dl">'</span><span class="s1">0x5B38Da6a701c568545dCfcB03FcB875f56beddC4</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0x</span><span class="dl">'</span><span class="p">])).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">0xd9145cce52d386f254917e481eb44e9943f39138</span><span class="dl">'</span>
</code></pre></div></div>

<h3 id="modify-initcode">Modify <code class="language-plaintext highlighter-rouge">initcode</code><a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#modify-initcode" aria-label="Anchor link for: modify initcode" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p>我们现在需要使用刚才计算的合约地址 <code class="language-plaintext highlighter-rouge">d9145cce52d386f254917e481eb44e9943f39138</code>， 替换掉原来的 <code class="language-plaintext highlighter-rouge">bytecode</code> 中 CHI 的地址 <code class="language-plaintext highlighter-rouge">4946c0e9f43f4dee607b0ef1fa1c</code>.</p>

<p>原始的 <code class="language-plaintext highlighter-rouge">initcode</code> 为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>746d(4946c0e9F43F4Dee607b0eF1fA1c)3318585733ff6000526015600bf30000
</code></pre></div></div>

<p>上面我用括号括起来的就是需要替换的地址。</p>

<p>参看这份 <a href="https://github.com/crytic/evm-opcodes">EVM opcodes</a> 表，在这个地址前的指令是 <code class="language-plaintext highlighter-rouge">6d</code> 即 <code class="language-plaintext highlighter-rouge">PUSH14</code>. 因为 CHI 的地址前面有很多个 0（一共有 6 个 byte 的 0），而我生成的地址是一个非 0 开头的 20byte 地址，因此这个 <code class="language-plaintext highlighter-rouge">6d</code> 指令也需要改写成为 <code class="language-plaintext highlighter-rouge">73</code> 即 <code class="language-plaintext highlighter-rouge">PUSH20</code>.</p>

<p>改写完成后，代码成了这样：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>74(73d9145cce52d386f254917e481eb44e9943f39138)3318585733ff6000526015600bf30000
</code></pre></div></div>

<p>为了方便比较，这里我还是将改动过的内容用括号括起来。</p>

<p>到这里还不够，来看第一个指令码 <code class="language-plaintext highlighter-rouge">74</code>，表示的是 <code class="language-plaintext highlighter-rouge">PUSH21</code>，即将原来长度为 21 字节的 <code class="language-plaintext highlighter-rouge">bytecode</code> push 到栈上。但是经过改写后，现在的 <code class="language-plaintext highlighter-rouge">bytecode</code> 长度增加了 6 个字节（因为新地址不是以 0 开头的了）。这里我们需要将原来的 <code class="language-plaintext highlighter-rouge">PUSH21</code> 改成 <code class="language-plaintext highlighter-rouge">PUSH27</code> 即 <code class="language-plaintext highlighter-rouge">7a</code>，改动后 <code class="language-plaintext highlighter-rouge">initcode</code> 为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(7a73d9145cce52d386f254917e481eb44e9943f39138)3318585733ff6000526015600bf30000
</code></pre></div></div>

<p>改动后，在 <code class="language-plaintext highlighter-rouge">initcode</code> 运行时，我们就能正确将 <code class="language-plaintext highlighter-rouge">bytecode</code> push 到栈上了，但是我们还需要将这段 <code class="language-plaintext highlighter-rouge">bytecode</code> 正确从内存中返回。在之前 <a href="https://paco0x.org/how-to-fork-a-chi/#initcode">initcode</a> 的讲解中，我们知道 <code class="language-plaintext highlighter-rouge">initcode</code> 会使用 <code class="language-plaintext highlighter-rouge">MSTORE</code> 将栈上的这段 <code class="language-plaintext highlighter-rouge">bytecode</code> 保存到内存中，然后返回内存中对应的字节。在原始 <code class="language-plaintext highlighter-rouge">initcode</code> 运行时，新合约地址空间中 EVM 的内存布局为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[MEMORY]
0x0: 0x00000000000000000000006d4946c0e9f43f4dee607b0ef1fa1c3318585733ff
</code></pre></div></div>

<p>现在我们进行了修改之后，这段 <code class="language-plaintext highlighter-rouge">initcode</code> 运行后 EVM 内存布局将为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[MEMORY]
0x0 0x0000000000073d9145cce52d386f254917e481eb44e9943f391383318585733ff
</code></pre></div></div>

<p>可以看到，在返回时，需要返回字节流的起始内存地址和长度都发生了变化。即我们需要将原来的 <code class="language-plaintext highlighter-rouge">return(11, 21)</code> 修改为 <code class="language-plaintext highlighter-rouge">return(5, 27)</code>。那么需要对 <code class="language-plaintext highlighter-rouge">initcode</code> 末尾返回的 opcode 进行修改，即将 <code class="language-plaintext highlighter-rouge">15</code>(21) 改成 <code class="language-plaintext highlighter-rouge">1b</code>(27)，<code class="language-plaintext highlighter-rouge">0b</code>(11) 改成 <code class="language-plaintext highlighter-rouge">05</code>(5).</p>

<p>最终修改过后的 <code class="language-plaintext highlighter-rouge">initcode</code> 为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(7a73d9145cce52d386f254917e481eb44e9943f39138)3318585733ff60005260(1b)60(05)f30000
</code></pre></div></div>

<p>去掉括号，即为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>7a73d9145cce52d386f254917e481eb44e9943f391383318585733ff600052601b6005f30000
</code></pre></div></div>

<h3 id="修改-mstore-和-create2">修改 mstore 和 create2<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#%E4%BF%AE%E6%94%B9-mstore-%E5%92%8C-create2" aria-label="Anchor link for: 修改 mstore 和 create2" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p>现在我们替换掉了原始合约中的 <code class="language-plaintext highlighter-rouge">initcode</code>，还会出现一个新的问题，因为这段 byte 已经超过了 32 字节，无法用一个 <code class="language-plaintext highlighter-rouge">MSTORE</code> 存储了，那么我们需要将原始的单次 <code class="language-plaintext highlighter-rouge">MSTORE</code> 修改成 2 次 <code class="language-plaintext highlighter-rouge">MSTORE</code> 操作（这里再次体现了 0 开头地址的优势）。</p>

<p>原始代码：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mstore(0, 0x746d4946c0e9F43F4Dee607b0eF1fA1c3318585733ff6000526015600bf30000)
</code></pre></div></div>

<p>需要修改为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mstore(0, 0x7a73d9145cce52d386f254917e481eb44e9943f391383318585733ff60005260)
msotre(32, 0x1b6005f300000000000000000000000000000000000000000000000000000000)
</code></pre></div></div>

<p>注意，第二次 <code class="language-plaintext highlighter-rouge">MSTORE</code> 的起始地址为 32，并且在末尾补零。顺带提一句，这里其实使用了 solidity 中预留给 hash 计算所使用的内存空间，但因为只是部署合约时临时使用，并不会出什么问题。但在 solidity 中其他用途需要使用 inline assembly 操作内存时，一定要遵守 solidity 的内存布局约定，否则可能造成无法预料的问题。关于 solidity 的 memory layout，可以参考：<a href="https://docs.soliditylang.org/en/latest/internals/layout_in_memory.html">Layout in Memory</a>.</p>

<p>因为 <code class="language-plaintext highlighter-rouge">bytecode</code> 长度变长了，我们还需要修改 <code class="language-plaintext highlighter-rouge">create2</code> 创建合约时指定的长度，原始合约中 <code class="language-plaintext highlighter-rouge">create2</code> 调用为：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<p>我们需要修改为：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="n">add</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<h3 id="修改-initcode-hash">修改 <code class="language-plaintext highlighter-rouge">initcode</code> hash<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#%E4%BF%AE%E6%94%B9-initcode-hash" aria-label="Anchor link for: 修改 initcode hash" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p><code class="language-plaintext highlighter-rouge">initcode</code> 修改了之后，在 <code class="language-plaintext highlighter-rouge">burn</code> token 时，用来计算子合约地址的 <code class="language-plaintext highlighter-rouge">initcode</code> hash 也需要随之修改，计算新 <code class="language-plaintext highlighter-rouge">initcode</code> 的 hash：</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">keccak256</span><span class="p">(</span><span class="dl">'</span><span class="s1">0x7a73d9145cce52d386f254917e481eb44e9943f391383318585733ff600052601b6005f3</span><span class="dl">'</span><span class="p">)</span>
<span class="dl">'</span><span class="s1">0x7d69959a9f587c867b817f2a61b1385bc8a30e11e7f336616df1b23e35be5009</span><span class="dl">'</span>
</code></pre></div></div>

<p>将结果替换掉原来的 <code class="language-plaintext highlighter-rouge">initcode</code> hash：</p>

<div class="language-solidity highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">computeAddress2</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">salt</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">bytes32</span> <span class="n">_data</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span>
        <span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="kt">bytes1</span><span class="p">(</span><span class="mh">0xff</span><span class="p">),</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">salt</span><span class="p">,</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mh">0x7d69959a9f587c867b817f2a61b1385bc8a30e11e7f336616df1b23e35be5009</span><span class="p">))</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="kt">address</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="n">_data</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="完成修改">完成修改<a class="anchorjs-link " href="https://paco0x.org/how-to-fork-a-chi/#%E5%AE%8C%E6%88%90%E4%BF%AE%E6%94%B9" aria-label="Anchor link for: 完成修改" data-anchorjs-icon="" style="font-family: anchorjs-icons; font-style: normal; font-variant: normal; font-weight: normal; padding-left: 0.375em;"></a></h3>

<p>这样就完成了对 fork 合约的所有修改。这里我使用测试网测试了一下 <code class="language-plaintext highlighter-rouge">mint</code> 和 <code class="language-plaintext highlighter-rouge">burn</code> 操作，都可以正常使用了。下图是我调用 fork CHI 合约的 <code class="language-plaintext highlighter-rouge">free</code> 函数来销毁合约：</p>

<p><img src="./How to fork a CHI gastoken_ - Fantasy_files/burn-forked-chi.png" alt="burn-forked-chi"></p>

<p>可以看到调用 <code class="language-plaintext highlighter-rouge">free</code> 函数成功销毁了合约，这个合约的地址是一个非 0 开头的地址（我在测试网部署的 fork 合约地址）。</p>

<p>到这里，fork CHI token 的所有流程就完成了，如果还有其他修改需求，就可以在这个修改后的合约之上来进行修改了。</p>

<p>Happy hacking!</p>


                <hr style="visibility: hidden;">

                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="https://paco0x.org/logarithm-in-solidity/" data-toggle="tooltip" data-placement="top" title="Solidity 中的对数计算">
                        Previous<br>
                        <span>Solidity 中的对数计算</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="https://paco0x.org/silo-finance/" data-toggle="tooltip" data-placement="top" title="下一代借贷协议 —— Silo Finance">
                        Next<br>
                        <span>下一代借贷协议 —— Silo Finance</span>
                        </a>
                    </li>
                    
                </ul>

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"><iframe id="dsq-app8466" name="dsq-app8466" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="./How to fork a CHI gastoken_ - Fantasy_files/saved_resource.html" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 769px !important;" horizontalscrolling="no" verticalscrolling="no"></iframe></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog fixed">
                    <hr class="hidden-sm hidden-xs">
                    <h5 id="catalog">
                        <a class="catalog-toggle" href="https://paco0x.org/how-to-fork-a-chi/#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"><li class="h1_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#what-is-gastoken" rel="nofollow">What is gastoken</a></li><li class="h1_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#why-use-gastoken" rel="nofollow">Why use gastoken</a></li><li class="h1_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#chi-gastoken" rel="nofollow">CHI gastoken</a></li><li class="h2_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#mint-gastoken" rel="nofollow">mint gastoken</a></li><li class="h3_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#initcode" rel="nofollow">initcode</a></li><li class="h3_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#bytecode" rel="nofollow">bytecode</a></li><li class="h2_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#burn-gastoken" rel="nofollow">burn gastoken</a></li><li class="h1_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#how-to-fork-a-chi" rel="nofollow">How to fork a CHI?</a></li><li class="h2_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#tackle-the-bytecode" rel="nofollow">Tackle the bytecode</a></li><li class="h3_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#compute-the-contract-address-in-advance" rel="nofollow">Compute the contract address in advance</a></li><li class="h3_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#modify-initcode" rel="nofollow">Modify initcode</a></li><li class="h3_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#%E4%BF%AE%E6%94%B9-mstore-%E5%92%8C-create2" rel="nofollow">修改 mstore 和 create2</a></li><li class="h3_nav active"><a href="https://paco0x.org/how-to-fork-a-chi/#%E4%BF%AE%E6%94%B9-initcode-hash" rel="nofollow">修改 initcode hash</a></li><li class="h3_nav"><a href="https://paco0x.org/how-to-fork-a-chi/#%E5%AE%8C%E6%88%90%E4%BF%AE%E6%94%B9" rel="nofollow">完成修改</a></li></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5 id="featured-tags"><a href="https://paco0x.org/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="https://paco0x.org/tags/#Life" title="Life" rel="3">
                                    Life
                                </a>
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Basic" title="Basic" rel="5">
                                    Basic
                                </a>
                            
        				
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Performance%20Tuning" title="Performance Tuning" rel="3">
                                    Performance Tuning
                                </a>
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Operating%20System" title="Operating System" rel="4">
                                    Operating System
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://paco0x.org/tags/#OpenStack" title="OpenStack" rel="2">
                                    OpenStack
                                </a>
                            
        				
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Python" title="Python" rel="2">
                                    Python
                                </a>
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Web" title="Web" rel="2">
                                    Web
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Solidity" title="Solidity" rel="11">
                                    Solidity
                                </a>
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Ethereum" title="Ethereum" rel="16">
                                    Ethereum
                                </a>
                            
        				
                            
                				<a href="https://paco0x.org/tags/#Uniswap" title="Uniswap" rel="8">
                                    Uniswap
                                </a>
                            
        				
                            
        				
                            
                				<a href="https://paco0x.org/tags/#DeFi" title="DeFi" rel="4">
                                    DeFi
                                </a>
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>






<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */

    var disqus_shortname = "liaoph";
    var disqus_config = function () {
        this.page.url = "http://paco0x.org/how-to-fork-a-chi/";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = "/how-to-fork-a-chi"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://paco0x.org/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://twitter.com/paco0x">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    
                    <li>
                        <a target="_blank" href="http://weibo.com/aoLiii">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/paco0x">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright © 坚实的幻想 2023
                    <br>
                    Theme by <a href="http://huangxuan.me/">Hux</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px" height="20px" src="./How to fork a CHI gastoken_ - Fantasy_files/github-btn.html">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="./How to fork a CHI gastoken_ - Fantasy_files/jquery.min.js.下载"></script>

<!-- Bootstrap Core JavaScript -->
<script src="./How to fork a CHI gastoken_ - Fantasy_files/bootstrap.min.js.下载"></script>

<!-- Custom Theme JavaScript -->
<script src="./How to fork a CHI gastoken_ - Fantasy_files/paco-blog.min.js.下载"></script>

<!-- Service Worker -->



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async('/js/jquery.tagcloud.js',function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script async="" src="./How to fork a CHI gastoken_ - Fantasy_files/js"></script>
<script>
  var _gaId = 'G-97JGLVEY5F';
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', _gaId);
</script>



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="./How to fork a CHI gastoken_ - Fantasy_files/icon_wechat.jpg" width="0" height="0">
<!-- Migrate from head to bottom, no longer block render and still work -->




<iframe style="display: none;" src="./How to fork a CHI gastoken_ - Fantasy_files/saved_resource(1).html"></iframe></body></html>